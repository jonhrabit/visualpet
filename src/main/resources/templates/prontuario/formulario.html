<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />


<link th:replace="~{fragmentos/css}"></link>

    <title>Prontuário</title>
    <link rel="icon" href="/images/icon.png" />
  </head>
  <body>
    <div th:replace="~{fragmentos/menu}"></div>
    <div class="container" style="padding: 20">
      <form
        th:object="${prontuario}"
        th:action="@{/prontuario/salvar}"
        method="POST"
      >
        <input name="id" id="id" th:field="*{id}" type="hidden" />
        <input
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <div class="row">
          <div class="alert alert-danger" th:if="${#fields.hasErrors('*')}">
            <p th:each="err : ${#fields.errors('*')}" th:text="${err}"></p>
          </div>

          <div class="col-md-6">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="dataPet" class="form-label">Pet</label>
                  <input
                    class="form-control"
                    list="datalistOptions"
                    id="dataPet"
                    placeholder="Pet"
                    autocomplete="off"
                    th:value="${prontuario.pet != null ? prontuario.pet.nome + ' ' + prontuario.pet.tutor.nome: ''}"
                  />
                  <input type="hidden" th:field="*{pet}" id="petId" />
                  <datalist id="datalistOptions">
                    <option
                      th:each="pet : ${listapet}"
                      th:value="|${pet.nome} - ${pet.tutor.nome}|"
                      th:text="|${pet.nome} - ${pet.tutor.nome}|"
                      th:data-id="${pet.id}"
                    ></option>
                  </datalist>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="data">Data</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="data"
                    th:field="*{data}"
                  />
                </div>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-group">
                <label for="texto">Queixa(Tutor)</label>
                <textarea
                  class="form-control"
                  type="text"
                  th:field="*{queixas}"
                  rows="6"
                >
                </textarea>
              </div>
            </div>

            <div class="col-md-12">
              <div class="form-group">
                <label for="texto">Exame Físico</label>
                <textarea
                  class="form-control"
                  type="text"
                  th:field="*{examesfisicos}"
                  rows="3"
                >
                </textarea>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="col-md-12">
              <div class="form-group">
                <label for="texto">Exame</label>
                <textarea
                  class="form-control"
                  type="text"
                  th:field="*{exames}"
                  rows="3"
                >
                </textarea>
              </div>
            </div>

            <div class="col-md-12">
              <div class="form-group">
                <label for="texto">Terapeutica</label
                ><a
                  class="btn btn-sm btn-primary ml-3"
                  th:href="@{/prontuario/__${prontuario.id}__/receita}"
                  >Receita</a
                >
                <textarea
                  class="form-control"
                  type="text"
                  th:field="*{terapeutica}"
                  rows="3"
                >
                </textarea>
              </div>
            </div>

            <div class="col-md-12">
              <div class="form-group">
                <label for="texto">Suspeitas</label>
                <textarea
                  class="form-control"
                  type="text"
                  th:field="*{suspeitas}"
                  rows="3"
                >
                </textarea>
              </div>
            </div>

            <div class="col-md-12">
              <div class="form-group">
                <label for="usuario">Veterinário:</label>
                <span id="usuario"></span>
              </div>
            </div>
          </div>

          <div class="form-group" id="div_salvar">
            <button
              type="submit"
              class="p-3 btn btn-primary"
              id="salvar"
              disabled="disabled"
            >
              Salvar
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="modal modal-warning fade" id="modal-mensagem">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Mensagem</h4>
            <button type="button" class="close" data-dismiss="modal">
              <span>×</span>
            </button>
          </div>
          <div class="modal-body">
            <p th:text="${mensagem}"></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:replace="~{fragmentos/js}"></script>

    <script th:inline="javascript">

      document.getElementById('dataPet').addEventListener('input', function(e) {
         var input = e.target.value;
         var options = document.getElementById('datalistOptions').options;
         var petId = '';
         for (var i = 0; i < options.length; i++) {
           if (options[i].value === input) {
             petId = options[i].getAttribute('data-id');
             break;
           }
         }
         document.getElementById('petId').value = petId;
       });



       var isInlineEdit = /* [[${mensagem} != null ? true:false]] */false;

        if(isInlineEdit){
      	  $(window).on('load', function() {
      			$('#modal-mensagem').modal('show');
      		});
            }
        var auth=/* [[${#authentication.getPrincipal()}]] */ "erro";
        $("#usuario").text(/* [[${prontuario.usuario}]] */ "erro");
        if(($("#usuario").text()==auth.username)||($("#usuario").text()=='')){
      	  $("#salvar").prop('disabled', false);
        }else{
      	  $("#div_salvar").append("<span class='muted'>(Apenas o veterinário signátario pode salvar alterações.)</span>");
        }
    </script>
  </body>
</html>
